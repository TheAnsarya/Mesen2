# Session Log: 2026-02-13 Session 01

## CI/CD Pipeline Fixes - Releases v1.1.2 → v1.1.4

**Branch:** master
**Issue:** #238 (closed)
**Final Tag:** v1.1.4
**Commits:**
- `d1e32f2e` — `fix(ci): disable macOS AOT builds temporarily (#238)`
- `108493aa` — `fix(ci): correct Windows artifact upload paths`
- `681b98e0` — `fix(ci): use explicit output directory for Windows publish`

## Summary

Fixed multiple CI/CD pipeline issues that were blocking releases:
1. macOS AOT builds failing due to .NET 10 ILC compiler bug (v1.1.2)
2. Windows artifacts not uploading due to incorrect path in workflow (v1.1.3, v1.1.4)

## Issue 1: macOS AOT ILC Crash

The GitHub Actions release job has `needs: [windows, linux, appimage, macos]`, requiring ALL platform jobs to pass. The macOS AOT job was failing with:

```text
.../ilc" @"obj/Release/native/Nexen.ilc.rsp"" exited with code 139
```

Exit code 139 = SIGSEGV in the .NET IL Compiler. This is a bug in .NET 10.0.3's AOT compiler, not in Nexen code.

**Fix:** Removed `clang_aot` from macOS build matrix in `.github/workflows/build.yml`

## Issue 2: Windows Artifacts Not Uploading

After fixing macOS AOT, the release v1.1.2 was created but **Windows assets were missing**. Investigation revealed:

1. The workflow expected artifacts at `build/TmpReleaseBuild/Nexen.exe`
2. But `dotnet publish` was outputting to `D:\bin\win-x64\Release\win-x64\publish\` on CI runners
3. The `$(SolutionDir)` MSBuild variable was resolving incorrectly on GitHub Actions

**Attempted fix (v1.1.3):** Changed artifact path to `bin/win-x64/Release/win-x64/publish/Nexen.exe` - **FAILED** because the `D:\bin\` path was outside the checkout directory (`D:\a\Nexen\Nexen\`).

**Final fix (v1.1.4):** Added explicit `-o build/publish` to the `dotnet publish` command to force output within the repo directory.

## Files Modified

| File | Change |
|------|--------|
| `.github/workflows/build.yml` | Removed macOS AOT + fixed Windows publish path |
| `README.md` | Updated macOS AOT row to show unavailable |
| `CHANGELOG.md` | Added v1.1.2, v1.1.3, v1.1.4 release notes |
| `~docs/plans/ci-cd-build-failures-analysis.md` | Created detailed analysis document |

## Release Assets (v1.1.4)

All 10 expected assets successfully uploaded:

| Asset | Size |
|-------|------|
| `Nexen-Windows-x64.exe` | 32 MB |
| `Nexen-Windows-x64-AoT.exe` | 73 MB |
| `Nexen-Linux-x64.AppImage` | 80 MB |
| `Nexen-Linux-ARM64.AppImage` | 75 MB |
| `Nexen-Linux-x64` | 20 MB |
| `Nexen-Linux-ARM64` | 20 MB |
| `Nexen-Linux-x64-AoT` | 39 MB |
| `Nexen-Linux-x64-gcc` | 19 MB |
| `Nexen-Linux-ARM64-gcc` | 18 MB |
| `Nexen-macOS-ARM64.zip` | 63 MB |

## Deleted Releases

- v1.1.2 — Deleted (Windows assets missing)
- v1.1.3 — Deleted (Windows artifacts still failed to upload)

## Future Work

When .NET releases an ILC fix:

1. Re-add `clang_aot` to the macOS build matrix
2. Uncomment the release asset copy line
3. Update README to show macOS AOT as available
4. Test with a pre-release tag first

---

## Session 01 Continued: Versioned Filenames + Linux Tarballs

**Commits:**
- `b21f95b5` — `feat(ci): add version numbers to release asset filenames`
- `a909e532` — `feat(ci): package Linux binaries as .tar.gz tarballs`

### Versioned Release Filenames

Updated `build.yml` to include version numbers in release asset names using `${GITHUB_REF_NAME}`:
- `Nexen-Windows-x64.exe` → `Nexen-Windows-x64-v1.1.4.exe`
- All platform assets now include version in filename

### Linux Tarball Distribution

Changed Linux binary distribution from raw executables to `.tar.gz` tarballs:
- Each tarball contains `Nexen` binary + `LICENSE`
- AppImages remain as standalone `.AppImage` files
- Better for standard Linux distribution practices

### C Code Investigation

GitHub reported 14.3% of codebase as C. Investigation revealed this is entirely **vendored third-party libraries**:

| Directory | Library | Files | Purpose |
|-----------|---------|-------|---------|
| `Lua/` | Lua 5.3 + LuaSocket | ~52 | Scripting engine |
| `SevenZip/` | 7-Zip LZMA SDK | ~20 | Compression |
| `Utilities/spng.c` | libspng | 1 | PNG encoding |
| `Linux/libevdev/` | libevdev | 1 | Linux input |

All project code is C++/C# — no custom C code.

### v1.1.4 Final Assets (10 files)

| Asset | Format |
|-------|--------|
| Nexen-Linux-ARM64-gcc-v1.1.4.tar.gz | tarball |
| Nexen-Linux-ARM64-v1.1.4.AppImage | AppImage |
| Nexen-Linux-ARM64-v1.1.4.tar.gz | tarball |
| Nexen-Linux-x64-AoT-v1.1.4.tar.gz | tarball |
| Nexen-Linux-x64-gcc-v1.1.4.tar.gz | tarball |
| Nexen-Linux-x64-v1.1.4.AppImage | AppImage |
| Nexen-Linux-x64-v1.1.4.tar.gz | tarball |
| Nexen-macOS-ARM64-v1.1.4.zip | zip |
| Nexen-Windows-x64-AoT-v1.1.4.exe | exe |
| Nexen-Windows-x64-v1.1.4.exe | exe |

---

## Session 01 Continued: Lua Library Replacement Research

**Issue:** [#239 - Replace Vendored Lua with Library Dependency](https://github.com/TheAnsarya/Nexen/issues/239)

### Findings

Investigated whether the vendored Lua C code (~74 files in `Lua/`) can be replaced with a prebuilt library.

**GitHub shows 14.3% C code** — This is entirely from vendored third-party libraries:
- Lua 5.4 + LuaSocket (~74 files)
- 7-Zip LZMA SDK (~20 files)
- libspng (1 file)
- libevdev (1 file)

### Lua Custom Modifications

The vendored Lua has **two custom modifications** marked as `// ##### NEXEN MODIFICATION #####`:

| Modification | Purpose | Files Modified |
|-------------|---------|----------------|
| Watchdog Timer | Prevents infinite loops in scripts | `lua.h`, `lstate.h`, `lstate.c`, `ldebug.c`, `lvm.c` |
| Sandbox Flag | Blocks `loadfile()`/`dofile()` | `lauxlib.h`, `lauxlib.c` |

### Can It Be Replaced?

**No — Performance trade-off too significant.**

We prototyped and benchmarked both approaches:

| Benchmark | Time (ns) | Relative |
|-----------|-----------|----------|
| No Hook (Baseline) | 781,074 | 1.0x |
| Custom Watchdog | 870,315 | 1.11x |
| Standard `lua_sethook` | 1,950,104 | 2.50x |

**Key Finding:** Standard `lua_sethook(LUA_MASKCOUNT)` is **~2.2x slower** than the custom watchdog due to `luaG_traceexec()` function overhead.

**Decision:** Keep vendored Lua with custom watchdog for performance reasons.

### Created

- Git tag: `lua-vendored-baseline` (at commit `4814930c`)
- [~docs/plans/lua-library-replacement-analysis.md](../plans/lua-library-replacement-analysis.md) (updated with benchmarks)
- [Core.Benchmarks/Lua/LuaHookBench.cpp](../../Core.Benchmarks/Lua/LuaHookBench.cpp)
- [Issue #239](https://github.com/TheAnsarya/Nexen/issues/239) — Closed (research complete)
- [Issue #240](https://github.com/TheAnsarya/Nexen/issues/240) — Sandbox flag cleanup (follow-up)

---

## Session 01 Continued: Sandbox Flag Cleanup + Lua Version Research

**Issue:** [#240 - Clean up Lua Sandbox Flag Implementation](https://github.com/TheAnsarya/Nexen/issues/240) (CLOSED)

### Lua Version Research

Investigated whether newer Lua versions have improved `lua_sethook` performance:

| Version | Our Vendored | Current 5.4 | New Major |
|---------|--------------|-------------|-----------|
| Lua | 5.4.4 | 5.4.8 (Jun 2025) | 5.5.0 (Dec 2025) |

**Hook-Related Changes Investigated:**
- **Lua 5.4.6 Bug #2:** "Call hook may be called twice when count hook yields" — **correctness fix**, not performance
- **Lua 5.5.0 Main Changes:**
  - Declarations for global variables
  - Named vararg tables
  - More compact arrays (60% less memory)
  - Incremental major GC
  - **No hook performance improvements**

**Conclusion:** Upgrading to Lua 5.4.8 or 5.5.0 would **not** improve hook performance. The standard
`lua_sethook()` architecture remains unchanged — full debug info setup per hook call.

### Sandbox Flag Cleanup (Issue #240)

**Removed the `SANDBOX_ALLOW_LOADFILE` global** from vendored Lua:

**Before:**
- Global flag `SANDBOX_ALLOW_LOADFILE` in `lauxlib.h`/`lauxlib.c`
- Checked in `luaL_loadfilex()` to block file operations
- Set by `ScriptingContext.cpp` based on settings

**After:**
- `LuaOpenLibs()` now directly unregisters `loadfile` and `dofile` from `_G` when sandboxed:
```cpp
if (!allowIoOsAccess) {
    lua_pushnil(L);
    lua_setglobal(L, "loadfile");
    lua_pushnil(L);
    lua_setglobal(L, "dofile");
}
```

### Files Modified

| File | Change |
|------|--------|
| `Core/Debugger/ScriptingContext.cpp` | Added loadfile/dofile unregistration, removed SANDBOX_ALLOW_LOADFILE |
| `Lua/lauxlib.h` | Removed `extern int SANDBOX_ALLOW_LOADFILE` |
| `Lua/lauxlib.c` | Removed SANDBOX_ALLOW_LOADFILE global and check |
| `~docs/plans/lua-library-replacement-analysis.md` | Updated with Lua version research + completion status |

### Remaining Vendored Lua Modifications

After cleanup, **only one custom modification** remains in vendored Lua:

| Modification | Purpose | Files |
|--------------|---------|-------|
| Watchdog Timer | Prevents infinite loops (11% overhead vs 150% for standard hook) | `lua.h`, `lstate.h`, `lstate.c`, `ldebug.c`, `lvm.c` |

This is **essential** and cannot be removed without accepting 2.2x performance degradation.

## References

- [Issue #238](https://github.com/TheAnsarya/Nexen/issues/238)
- [Issue #239](https://github.com/TheAnsarya/Nexen/issues/239) — Closed
- [Issue #240](https://github.com/TheAnsarya/Nexen/issues/240) — Closed
- [Release v1.1.4](https://github.com/TheAnsarya/Nexen/releases/tag/v1.1.4)
- [Analysis Document](../plans/ci-cd-build-failures-analysis.md)
- [Lua Library Analysis](../plans/lua-library-replacement-analysis.md)
