# Session Log — 2026-02-20 Session 01

## Lynx Audit: Fix Remaining 16 Issues (#392–#407)

### Summary

Continued from the previous session's Lynx code audit (24 total issues found, 8 fixed in #390). This session created 16 GitHub issues for the remaining problems, implemented all fixes, added regression tests, and closed all issues.

### Work Performed

#### Phase 1: GitHub Issue Creation

Created 16 issues (#392–#407) **before** any implementation, per user's explicit request:

| Issue | Title | Severity |
|-------|-------|----------|
| #392 | [12.10] Vector space writes not blocked | High |
| #393 | [12.11] Duplicate APU state in LynxState | High |
| #394 | [12.12] Cart ShiftRegister written but never read | Medium |
| #395 | [12.13] Cart SetBank0Page/SetBank1Page overwrite address | Medium |
| #396 | [12.14] MAPCTL write redundantly stores to RAM | Medium |
| #397 | [12.15] IODAT read only handles EEPROM bit | Medium |
| #398 | [12.16] CpuCyclesPerFrame rounding error | Medium |
| #399 | [12.17] _prevIrqPending dead code | Low |
| #400 | [12.18] IRQFlag/NmiFlag not serialized | Low |
| #401 | [12.19] IrqEnabled never written | Low |
| #402 | [12.20] GetVideoFilter ignores parameter | Low |
| #403 | [12.21] Multi-byte NOP wrong cycle counts | Low |
| #404 | [12.22] Cart serialization missing CartInfo | Low |
| #405 | [12.23] PeekRegister const_cast | Low |
| #406 | [12.24] EEPROM double-init dead code | Low |
| #407 | [12.25] Display address not validated | Low |

All issues had prompt tracking comments added.

#### Phase 2: Implementation

**Files modified (12):**

| File | Changes |
|------|---------|
| `Core/Lynx/LynxMemoryManager.cpp` | Block vector space writes (#392), remove MAPCTL RAM write (#396) |
| `Core/Lynx/LynxConsole.cpp` | Remove duplicate APU state population (#393), `[[maybe_unused]]` on GetVideoFilter (#402), remove EEPROM dead code (#406) |
| `Core/Lynx/LynxCpu.h` | Remove `_prevIrqPending` (#399), add `NOP_5C()`/`NOP_DC()` (#403) |
| `Core/Lynx/LynxCpu.cpp` | Fix NOP opcode table (#403), serialize IRQFlag (#400), remove dead serialization (#399) |
| `Core/Lynx/LynxTypes.h` | Fix CpuCyclesPerFrame: `CpuClockRate/Fps` = 53333 (#398), remove top-level Apu from LynxState (#393) |
| `Core/Lynx/LynxMikey.cpp` | Track IrqEnabled from CTLA bit 7 (#401), document IODAT bits (#397), validate display address (#407), **rewrite PeekRegister** without const_cast (#405) |
| `Core/Lynx/LynxSuzy.cpp` | **Rewrite PeekRegister** without const_cast (#405) |
| `Core/Lynx/LynxCart.cpp` | Document ShiftRegister (#394), bank/address behavior (#395), CartInfo serialization choice (#404) |
| `UI/Interop/ConsoleState/LynxState.cs` | Remove duplicate Apu field (#393) |
| `Core.Tests/Lynx/LynxCpuTests.cpp` | Fix CyclesPerFrame test, add 3 audit regression tests |
| `Core.Tests/Lynx/LynxMemoryTests.cpp` | Add 4 audit regression tests |
| `Core.Tests/Lynx/LynxCartTests.cpp` | Add 3 audit regression tests |

**Key technical decisions:**

1. **CpuCyclesPerFrame (#398):** Changed from `ScanlineCount * CpuCyclesPerScanline` (53235) to `CpuClockRate / Fps` (53333). The latter is the authoritative calculation — the naive scanline-based value loses ~98 cycles/frame due to integer rounding.

2. **Duplicate APU state (#393):** Removed `LynxState.Apu` (top-level) since `LynxState.Mikey.Apu` already exists and is the authoritative source. Updated both C++ and C# structs. No UI code referenced the top-level field.

3. **PeekRegister (#405):** Rewrote both `LynxMikey::PeekRegister` and `LynxSuzy::PeekRegister` as fully standalone const methods with duplicated switch logic instead of relying on `const_cast<>` + `ReadRegister()`. This is cleaner, safer, and catches any future side-effect additions.

4. **CartInfo serialization (#404):** Documented as intentionally NOT serialized — CartInfo is derived from the LNX ROM header and reconstructed on load, so serializing it would waste save state space.

5. **IODAT (#397):** Documented the full 8-bit layout (CS, DI/DO, CLK, AUDIN, pins 4-7). The existing code already correctly handles output bits via `_ioData & _ioDir` and input via EEPROM readback.

#### Phase 3: Testing

- **749 Lynx tests passing** (10 new regression tests added)
- Tests cover: CpuCyclesPerFrame, IRQFlag, APU state location, vector space, IrqEnabled, display address wrapping, ShiftRegister, bank page-select, CartInfo layout

### Commits

| Hash | Description |
|------|-------------|
| `39ffdfc5` | Lynx audit fixes: 16 issues (#392-#407) |

### Branch

`features-atari-lynx`

### Issues Closed

#392, #393, #394, #395, #396, #397, #398, #399, #400, #401, #402, #403, #404, #405, #406, #407

### Audit Completion

The full 24-issue Lynx code audit is now **100% complete**:
- Issues #1-#9, #14 → Fixed in commit `a22ee9fa` (issue #390, previous session)
- Issues #10-#13, #15-#25 → Fixed in commit `39ffdfc5` (issues #392-#407, this session)
