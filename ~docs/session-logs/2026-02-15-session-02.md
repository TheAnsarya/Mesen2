# Session Log: 2026-02-15 Session 02

## Overview

**Focus:** TAS/Movie System Performance Audit & Optimization  
**Branch:** `master`  
**Issues Addressed:** #261, #262, #265  
**Duration:** ~45 minutes

## Summary

Comprehensive performance audit of the TAS/movie subsystem, identifying O(n*k) loops, O(n) LINQ on hot properties, and duplicate code that missed fields. Implemented all fixes with tests and benchmarks proving improvements.

## Work Completed

### 1. Issue #265: Duplicate CloneFrame Elimination

**Problem:** Both `TasEditorViewModel.cs` and `InputRecorder.cs` had private `CloneFrame`/`CloneInput` methods that only copied 12 button fields (A, B, X, Y, L, R, Up, Down, Left, Right, Start, Select), missing MouseX/Y, AnalogX/Y, ButtonBits, Type, and other fields. The canonical `InputFrame.Clone()` in MovieConverter copies ALL fields.

**Fix:**
- Replaced all `CloneFrame`/`CloneInput` calls with `InputFrame.Clone()` and `ControllerInput.Clone()`
- Removed duplicate `CloneFrame` method from `TasEditorViewModel.cs` (~27 lines)
- Removed duplicate `CloneFrame` + `CloneInput` methods from `InputRecorder.cs` (~28 lines)
- Fixed 4 call sites: paste, copy, CreateBranch, LoadBranch, RecordFrame

**Files modified:**
- `UI/ViewModels/TasEditorViewModel.cs` - 2 call sites + method removal
- `UI/TAS/InputRecorder.cs` - 3 call sites + 2 method removals

### 2. Issue #261: O(n*k) RemoveAt/Insert Loops → Bulk Operations

**Problem:** `InsertFramesAction` and `DeleteFramesAction` used per-element loops for bulk operations, resulting in O(n*k) time where n = movie length and k = frames being modified. Fork truncation used a while loop removing from end.

**Fix (completed in previous session, verified this session):**
- `InsertFramesAction.Execute()`: `for` loop with `Insert()` → `InsertRange()`
- `InsertFramesAction.Undo()`: `for` loop with `RemoveAt()` → `RemoveRange()`
- `DeleteFramesAction` constructor: `Skip(n).Take(k).ToList()` → `GetRange(n, k)`
- `DeleteFramesAction.Execute()`: `for` loop with `RemoveAt()` → `RemoveRange()`
- `DeleteFramesAction.Undo()`: `for` loop with `Insert()` → `InsertRange()`
- Fork truncation: `while` loop with `RemoveAt(Count-1)` → `RemoveRange()`

### 3. Issue #262: GreenzoneManager O(n) LINQ → O(log n) SortedSet

**Problem:** Three properties (`LatestFrame`, `EarliestFrame`, `TotalMemoryUsage`) and `GetNearestStateFrame()` used O(n) LINQ queries on every access. In a greenzone with 1000+ states, this was called on every seek operation.

**Fix:**
- Added `SortedSet<int> _frameIndex` as a parallel O(log n) sorted index
- `LatestFrame` → `_frameIndex.Max` (O(log n) vs O(n))
- `EarliestFrame` → `_frameIndex.Min` (O(log n) vs O(n))
- `TotalMemoryUsage` → `Interlocked.Read(ref _totalMemoryUsage)` (O(1) vs O(n))
- `GetNearestStateFrame()` → `_frameIndex.GetViewBetween().Max` (O(log n) vs O(n))
- Updated ALL mutation points to maintain index + memory tracking:
  - `CaptureState`, `InvalidateFrom`, `Clear`, `PruneSavestates`, `AddToRingBuffer`, `CompressOldStatesAsync`, `Dispose`
- `LoadState` now calls `GetNearestStateFrame()` instead of duplicating the LINQ query

**File modified:** `UI/TAS/GreenzoneManager.cs`

### 4. Tests Added (49 tests, all passing)

- `Tests/TAS/GreenzoneManagerOptimizationTests.cs` - 22 tests covering:
  - LatestFrame/EarliestFrame tracking through add/invalidate/clear
  - TotalMemoryUsage tracking through add/replace/invalidate/clear
  - GetNearestStateFrame with SortedSet (exact, between, before-all, after-all, single, post-invalidation)
  - InvalidateFrom correctness
  - CaptureState index consistency
  - Clear resets everything
  - Event firing

- `Tests/TAS/BulkOperationTests.cs` - 27 tests covering:
  - InsertRange vs Insert loop equivalence (4 parameterized)
  - RemoveRange vs RemoveAt loop equivalence (4 parameterized)
  - GetRange vs Skip/Take equivalence (4 parameterized)
  - Fork truncation RemoveRange vs while loop (4 parameterized)
  - InputFrame.Clone() copies all fields
  - InputFrame.Clone() is deep copy
  - ControllerInput.Clone() copies all button fields
  - Select(Clone) produces independent list

### 5. Benchmarks (proving improvements)

`Benchmarks/TasOptimizationBenchmarks.cs` - 48 benchmarks comparing old vs new approaches:

#### Key Results (100K movie / 100K greenzone states):

| Category | Old | New | Speedup |
|----------|-----|-----|---------|
| NearestFrame (LINQ vs SortedSet) | 19,135 ns | 36 ns | **526x faster** |
| LatestFrame (LINQ vs SortedSet.Max) | O(n) | O(log n) | **significant** |
| TotalMemoryUsage (Sum vs Interlocked) | 18,842 ns | ~1 ns | **~18,000x faster** |
| Truncate 1K (while vs RemoveRange) | 1,165 ns | 616 ns | **1.9x faster** |
| Truncate 10K (while vs RemoveRange) | 12,768 ns | 6,339 ns | **2.0x faster** |
| GetRange vs Skip.Take | ~80 μs | ~77 μs | **1.05x + less alloc** |

## Issues Status

| Issue | Title | Status |
|-------|-------|--------|
| #261 | O(n*k) RemoveAt loops | Fixed (prior session + verified) |
| #262 | GreenzoneManager LINQ properties | **Fixed this session** |
| #265 | Duplicate CloneFrame methods | **Fixed this session** |
| #266 | Temp file I/O for savestates | Deferred (needs C++ API) |

## Files Changed

- `UI/ViewModels/TasEditorViewModel.cs` - CloneFrame removal, copy fix
- `UI/TAS/InputRecorder.cs` - CloneFrame/CloneInput removal, Clone() usage
- `UI/TAS/GreenzoneManager.cs` - SortedSet index, tracked memory, O(log n) lookups
- `Tests/TAS/GreenzoneManagerOptimizationTests.cs` - NEW (22 tests)
- `Tests/TAS/BulkOperationTests.cs` - NEW (27 tests)
- `Benchmarks/TasOptimizationBenchmarks.cs` - NEW (48 benchmarks)
